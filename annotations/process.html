<!DOCTYPE html>  <html> <head>   <title>process.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="client.html">                 client.coffee               </a>                                           <a class="source" href="pool.html">                 pool.coffee               </a>                                           <a class="source" href="process.html">                 process.coffee               </a>                                           <a class="source" href="server.html">                 server.coffee               </a>                                           <a class="source" href="util.html">                 util.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               process.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">client              = </span><span class="nx">require</span> <span class="s1">&#39;./client&#39;</span>
<span class="nv">fs                  = </span><span class="nx">require</span> <span class="s1">&#39;fs&#39;</span>
<span class="p">{</span><span class="nx">exists</span><span class="p">}</span>            <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;path&#39;</span>
<span class="p">{</span><span class="nx">pause</span><span class="p">,</span> <span class="nx">isFunction</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./util&#39;</span>
<span class="p">{</span><span class="nx">debug</span><span class="p">}</span>             <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./util&#39;</span>
<span class="p">{</span><span class="nx">LineBuffer</span><span class="p">}</span>        <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./util&#39;</span>
<span class="p">{</span><span class="nx">spawn</span><span class="p">,</span> <span class="nx">exec</span><span class="p">}</span>       <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;child_process&#39;</span>
<span class="p">{</span><span class="nx">EventEmitter</span><span class="p">}</span>      <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;events&#39;</span>
<span class="p">{</span><span class="nx">Stream</span><span class="p">}</span>            <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;net&#39;</span>

<span class="nv">packageBin = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">realpathSync</span> <span class="s2">&quot;#{__dirname}/../../bin&quot;</span>
<span class="nv">packageLib = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">realpathSync</span> <span class="s2">&quot;#{__dirname}/..&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p><strong>Process</strong> manages a single Ruby worker process.</p>

<p>A Process requires a path to a rackup config file <em>(config.ru)</em>.</p>

<pre><code>process.createProcess("/path/to/app/config.ru");
</code></pre>

<p>You can set a idle time so the process dies after a
specified amount of milliseconds.</p>

<pre><code>var ms = 15 * 60 * 1000;
process.createProcess("/path/to/app/config.ru", { idle: ms });
</code></pre>

<p>A Process has 5 states:</p>

<blockquote>
  <p><code>null</code>: Not started or dead</p>
  
  <p><code>spawning</code>: Is booting and can't accept a connection yet</p>
  
  <p><code>ready</code>: Is ready to accept a connection and handle a request</p>
  
  <p><code>busy</code>: Is currently handling a request, not ready</p>
  
  <p><code>quitting</code>: Was set a kill signal and is shutting down</p>
</blockquote>

<p>Anytime a process changes states, an event is fired with the new
state name. When the process becomes <code>ready</code>, a <code>ready</code> is fired.</p>

<p>Other events:</p>

<blockquote>
  <p><strong>Event: 'error'</strong></p>
  
  <p><code>function (exception) { }</code></p>
  
  <p>Emitted when an error occurs.</p>
  
  <p><strong>Event: 'spawn'</strong></p>
  
  <p><code>function (exception) { }</code></p>
  
  <p>Emitted when the process moves from <code>spawning</code> to <code>ready</code> state.</p>
  
  <p><strong>Event: 'exit'</strong></p>
  
  <p><code>function () { }</code></p>
  
  <p>Emitted when the Process terminates.</p>
  
  <p><strong>Event: 'idle'</strong></p>
  
  <p><code>function () { }</code></p>
  
  <p>Emitted when the Process times out because of inactivity.</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Process = </span><span class="k">class</span> <span class="nx">Process</span> <span class="k">extends</span> <span class="nx">EventEmitter</span>
  <span class="nv">constructor: </span><span class="nf">(@config, options) -&gt;</span>
    <span class="nv">self = </span><span class="err">@</span>
    <span class="vi">@id = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span>

    <span class="nx">options</span> <span class="o">?=</span> <span class="p">{}</span>
    <span class="vi">@idle  = </span><span class="nx">options</span><span class="p">.</span><span class="nx">idle</span>
    <span class="vi">@cwd   = </span><span class="nx">options</span><span class="p">.</span><span class="nx">cwd</span>
    <span class="vi">@env   = </span><span class="nx">options</span><span class="p">.</span><span class="nx">env</span> <span class="o">?</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Set initial state to <code>null</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@state = </span><span class="kc">null</span>

    <span class="vi">@_connectionQueue = </span><span class="p">[]</span>
    <span class="vi">@_activeConnection = </span><span class="kc">null</span>

    <span class="nv">raiseConfigError = </span><span class="o">-&gt;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;configuration \&quot;#{@config}\&quot; doesn&#39;t exist&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Raise an exception unless <code>config</code> exists</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@config</span><span class="o">?</span>
      <span class="nx">exists</span> <span class="nx">@config</span><span class="p">,</span> <span class="nf">(ok) -&gt;</span>
        <span class="nx">raiseConfigError</span><span class="p">()</span> <span class="k">if</span> <span class="o">!</span><span class="nx">ok</span>
    <span class="k">else</span>
      <span class="nx">raiseConfigError</span><span class="p">()</span>

    <span class="nx">@on</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">_processConnections</span><span class="p">()</span>

    <span class="nx">@on</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nf">(error) -&gt;</span>
      <span class="nv">callback = </span><span class="nx">self</span><span class="p">.</span><span class="nx">_activeConnection</span>
      <span class="nv">self._activeConnection = </span><span class="kc">null</span>

      <span class="k">if</span> <span class="nx">callback</span>
        <span class="nx">callback</span> <span class="nx">error</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">self</span><span class="p">.</span><span class="nx">listeners</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span>
        <span class="k">throw</span> <span class="nx">error</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Push back the idle time everytime a request is handled</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@on</span> <span class="s1">&#39;busy&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">deferTimeout</span><span class="p">()</span>

  <span class="nv">spawn: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Do nothing if the process is already started</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="k">if</span> <span class="nx">@state</span>

    <span class="nx">debug</span> <span class="s2">&quot;spawning process&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Change start to <code>spawning</code> and fire an event</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@changeState</span> <span class="s1">&#39;spawning&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Generate a random sock path</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@sockPath = </span><span class="s2">&quot;#{tmpFile()}.sock&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Copy process environment</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">env = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span>
      <span class="nx">env</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">@env</span>
      <span class="nx">env</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>

    <span class="nx">env</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="s2">&quot;#{packageBin}:#{env[&#39;PATH&#39;]}&quot;</span>
    <span class="nx">env</span><span class="p">[</span><span class="s1">&#39;RUBYLIB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#{packageLib}:#{env[&#39;RUBYLIB&#39;]}&quot;</span>

    <span class="vi">@heartbeat = </span><span class="k">new</span> <span class="nx">Stream</span>

    <span class="nx">@heartbeat</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="nx">debug</span> <span class="s2">&quot;process spawned&quot;</span>
      <span class="nx">@emit</span> <span class="s1">&#39;spawn&#39;</span>

    <span class="nx">@heartbeat</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="s2">&quot;#{@child.pid}\n&quot;</span> <span class="o">is</span> <span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nx">@changeState</span> <span class="s1">&#39;ready&#39;</span>
      <span class="k">else</span>
        <span class="k">try</span>
          <span class="nv">exception   = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">data</span>
          <span class="nv">error       = </span><span class="k">new</span> <span class="nb">Error</span> <span class="nx">exception</span><span class="p">.</span><span class="nx">message</span>
          <span class="nv">error.name  = </span><span class="nx">exception</span><span class="p">.</span><span class="nx">name</span>
          <span class="nv">error.stack = </span><span class="nx">exception</span><span class="p">.</span><span class="nx">stack</span>

          <span class="nx">debug</span> <span class="s2">&quot;heartbeat error&quot;</span><span class="p">,</span> <span class="nx">error</span>
          <span class="nx">@emit</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">error</span>
        <span class="k">catch</span> <span class="nx">e</span>
          <span class="nx">debug</span> <span class="s2">&quot;heartbeat error&quot;</span><span class="p">,</span> <span class="nx">e</span>
          <span class="nx">@emit</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;unknown process error&quot;</span>

    <span class="nx">tryConnect</span> <span class="nx">@heartbeat</span><span class="p">,</span> <span class="nx">@sockPath</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">and</span> <span class="nx">out</span>
        <span class="nx">@emit</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span> <span class="nx">out</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">@emit</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Spawn a Ruby server connecting to our <code>@sockPath</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@child = </span><span class="nx">spawn</span> <span class="s2">&quot;nack_worker&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nx">@config</span><span class="p">,</span> <span class="nx">@sockPath</span><span class="p">],</span>
      <span class="nv">cwd: </span><span class="nx">@cwd</span>
      <span class="nv">env: </span><span class="nx">env</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Expose <code>stdout</code> and <code>stderr</code> on Process</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@stdout = </span><span class="nx">@child</span><span class="p">.</span><span class="nx">stdout</span>
    <span class="vi">@stderr = </span><span class="nx">@child</span><span class="p">.</span><span class="nx">stderr</span>

    <span class="nv">out = </span><span class="kc">null</span>
    <span class="nv">logData = </span><span class="nf">(data) -&gt;</span>
      <span class="nx">out</span> <span class="o">?=</span> <span class="s2">&quot;&quot;</span>
      <span class="nx">out</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>

    <span class="nx">@stdout</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">logData</span>
    <span class="nx">@stderr</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">logData</span>

    <span class="nx">@on</span> <span class="s1">&#39;spawn&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="nv">out = </span><span class="kc">null</span>
      <span class="nx">@stdout</span><span class="p">.</span><span class="nx">removeListener</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">logData</span>
      <span class="nx">@stderr</span><span class="p">.</span><span class="nx">removeListener</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">logData</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>When the child process exists, clear out state and emit <code>exit</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@child</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">signal</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">debug</span> <span class="s2">&quot;process exited&quot;</span>

      <span class="nx">@clearTimeout</span><span class="p">()</span>
      <span class="nx">@heartbeat</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@heartbeat</span>

      <span class="vi">@state = @sockPath = </span><span class="kc">null</span>
      <span class="vi">@child = @heartbeat = </span><span class="kc">null</span>
      <span class="vi">@stdout = @stderr = </span><span class="kc">null</span>

      <span class="vi">@_connectionQueue = </span><span class="p">[]</span>
      <span class="vi">@_activeConnection = </span><span class="kc">null</span>

      <span class="nx">@emit</span> <span class="s1">&#39;exit&#39;</span>

    <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Change the current state and fire a corresponding event</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">changeState: </span><span class="nf">(state) -&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="k">if</span> <span class="nx">@state</span> <span class="o">!=</span> <span class="nx">state</span>
      <span class="vi">@state = </span><span class="nx">state</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>State change events are always asynchronous</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span> <span class="o">-&gt;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span> <span class="nx">state</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Clear current timeout handler.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">clearTimeout: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@_timeoutId</span>
      <span class="nx">clearTimeout</span> <span class="nx">@_timeoutId</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Defer the current idle timer.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">deferTimeout: </span><span class="o">-&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="k">if</span> <span class="nx">@idle</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Clear the current timer</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@clearTimeout</span><span class="p">()</span>

      <span class="nv">callback = </span><span class="o">-&gt;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span> <span class="s1">&#39;idle&#39;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">quit</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Register a new timer</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@_timeoutId = </span><span class="nx">setTimeout</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">@idle</span>

  <span class="nv">_processConnections: </span><span class="o">-&gt;</span>
    <span class="nv">self = </span><span class="err">@</span>

    <span class="nx">unless</span> <span class="nx">@_activeConnection</span>
      <span class="vi">@_activeConnection = </span><span class="nx">@_connectionQueue</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">@_activeConnection</span> <span class="o">and</span> <span class="nx">@state</span> <span class="o">is</span> <span class="s1">&#39;ready&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Immediately flag process as <code>busy</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@changeState</span> <span class="s1">&#39;busy&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Create a connection to our sock path</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">connection = </span><span class="nx">client</span><span class="p">.</span><span class="nx">createConnection</span> <span class="nx">@sockPath</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>When the connection closes, change the state back to ready.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">connection</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
        <span class="nv">self._activeConnection = </span><span class="kc">null</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">changeState</span> <span class="s1">&#39;ready&#39;</span>

      <span class="nx">@_activeConnection</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">connection</span>
    <span class="k">else</span>
      <span class="nx">@spawn</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Create a new <strong>Client</strong> connection</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">createConnection: </span><span class="nf">(callback) -&gt;</span>
    <span class="nx">@_connectionQueue</span><span class="p">.</span><span class="nx">push</span> <span class="nx">callback</span>
    <span class="nx">@_processConnections</span><span class="p">()</span>
    <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Proxies a <code>http.ServerRequest</code> and <code>http.ServerResponse</code> to the process</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">proxyRequest: </span><span class="nf">(req, res, args...) -&gt;</span>
    <span class="nx">debug</span> <span class="s2">&quot;proxy #{req.method} #{req.url}&quot;</span>

    <span class="nv">self = </span><span class="err">@</span>

    <span class="k">if</span> <span class="nx">isFunction</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">callback = </span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="nv">metaVariables = </span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">callback = </span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Pause request so we don't miss any <code>data</code> or <code>end</code> events.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">resume = </span><span class="nx">pause</span> <span class="nx">req</span>

    <span class="nx">@createConnection</span> <span class="nf">(err, connection) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="k">if</span> <span class="nx">callback</span> <span class="k">then</span> <span class="nx">callback</span> <span class="nx">err</span>
        <span class="k">else</span> <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">callback</span>
          <span class="nx">connection</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="nx">callback</span>
          <span class="nx">connection</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nf">(error) -&gt;</span>
            <span class="nx">connection</span><span class="p">.</span><span class="nx">removeListener</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="nx">callback</span>
            <span class="nx">callback</span> <span class="nx">error</span>

        <span class="nx">connection</span><span class="p">.</span><span class="nx">proxyRequest</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">metaVariables</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Flush any events captured while we were establishing
our client connection</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">resume</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Send <code>SIGKILL</code> to process.
This will kill it for sure.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">kill: </span><span class="o">-&gt;</span>
    <span class="nx">debug</span> <span class="s2">&quot;process kill&quot;</span>

    <span class="k">if</span> <span class="nx">@child</span>
      <span class="nx">@changeState</span> <span class="s1">&#39;quitting&#39;</span>
      <span class="nx">@child</span><span class="p">.</span><span class="nx">kill</span> <span class="s1">&#39;SIGKILL&#39;</span>
      <span class="nx">@heartbeat</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@heartbeat</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Send <code>SIGTERM</code> to process.
This will immediately kill it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">terminate: </span><span class="o">-&gt;</span>
    <span class="nx">debug</span> <span class="s2">&quot;process terminate&quot;</span>

    <span class="k">if</span> <span class="nx">@child</span>
      <span class="nx">@changeState</span> <span class="s1">&#39;quitting&#39;</span>
      <span class="nx">@child</span><span class="p">.</span><span class="nx">kill</span> <span class="s1">&#39;SIGTERM&#39;</span>
      <span class="nx">@heartbeat</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@heartbeat</span>

      <span class="nv">timeout = </span><span class="nx">setTimeout</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">@state</span> <span class="o">is</span> <span class="s1">&#39;quitting&#39;</span>
          <span class="nx">@kill</span><span class="p">()</span>
      <span class="p">,</span> <span class="mi">10000</span>
      <span class="nx">@once</span> <span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">clearTimeout</span> <span class="nx">timeout</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Send <code>SIGTERM</code> to process.
The process will finish serving its request and gracefully quit.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">quit: </span><span class="o">-&gt;</span>
    <span class="nx">debug</span> <span class="s2">&quot;process quit&quot;</span>

    <span class="k">if</span> <span class="nx">@child</span>
      <span class="nx">@changeState</span> <span class="s1">&#39;quitting&#39;</span>
      <span class="nx">@child</span><span class="p">.</span><span class="nx">kill</span> <span class="s1">&#39;SIGQUIT&#39;</span>
      <span class="nx">@heartbeat</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@heartbeat</span>

      <span class="nv">timeout = </span><span class="nx">setTimeout</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">@state</span> <span class="o">is</span> <span class="s1">&#39;quitting&#39;</span>
          <span class="nx">@terminate</span><span class="p">()</span>
      <span class="p">,</span> <span class="mi">3000</span>
      <span class="nx">@once</span> <span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nx">clearTimeout</span> <span class="nx">timeout</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Quit and respawn process</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">restart: </span><span class="o">-&gt;</span>
    <span class="nx">debug</span> <span class="s2">&quot;process restart&quot;</span>

    <span class="nx">@once</span> <span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@spawn</span><span class="p">()</span>
    <span class="nx">@quit</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Public API for creating a <strong>Process</strong></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.createProcess = </span><span class="nf">(args...) -&gt;</span>
  <span class="k">new</span> <span class="nx">Process</span> <span class="nx">args</span><span class="p">...</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Generates a random path.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">tmpFile = </span><span class="o">-&gt;</span>
  <span class="nv">pid  = </span><span class="nx">process</span><span class="p">.</span><span class="nx">pid</span>
  <span class="nv">rand = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10000000000</span>
  <span class="s2">&quot;/tmp/nack.&quot;</span> <span class="o">+</span> <span class="nx">pid</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">rand</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>TODO: Don't poll FS</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">onceFileExists = </span><span class="nf">(path, callback, timeout = 3000) -&gt;</span>
  <span class="nv">timeoutError = </span><span class="kc">null</span>
  <span class="nv">timeoutId = </span><span class="nx">setTimeout</span> <span class="o">-&gt;</span>
    <span class="nv">timeoutError = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;timeout: waiting for #{path}&quot;</span>
  <span class="p">,</span> <span class="nx">timeout</span>

  <span class="nv">decay = </span><span class="mi">1</span>

  <span class="nv">statPath = </span><span class="nf">(err, stat) -&gt;</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">err</span> <span class="o">and</span> <span class="nx">stat</span> <span class="o">and</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">isSocket</span><span class="p">()</span>
      <span class="nx">clearTimeout</span> <span class="nx">timeoutId</span>
      <span class="nx">callback</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">path</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">timeoutError</span>
      <span class="nx">callback</span> <span class="nx">timeoutError</span><span class="p">,</span> <span class="nx">path</span>
    <span class="k">else</span>
      <span class="nx">setTimeout</span> <span class="o">-&gt;</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">statPath</span>
      <span class="p">,</span> <span class="nx">decay</span> <span class="o">*=</span> <span class="mi">2</span>

  <span class="nx">statPath</span><span class="p">()</span>

<span class="nv">tryConnect = </span><span class="nf">(connection, path, callback) -&gt;</span>
  <span class="nv">errors = </span><span class="mi">0</span>

  <span class="nv">reconnect = </span><span class="o">-&gt;</span>
    <span class="nx">onceFileExists</span> <span class="nx">path</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">connection</span><span class="p">.</span><span class="nx">connect</span> <span class="nx">path</span>

  <span class="nv">onError = </span><span class="nf">(err) -&gt;</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">and</span> <span class="o">++</span><span class="nx">errors</span> <span class="o">&gt;</span> <span class="mi">3</span>
      <span class="nx">connection</span><span class="p">.</span><span class="nx">removeListener</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">onError</span>
      <span class="nx">callback</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;timeout: couldn&#39;t connect to #{path}&quot;</span>
    <span class="k">else</span>
      <span class="nx">reconnect</span><span class="p">()</span>

  <span class="nx">connection</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">onError</span>

  <span class="nx">connection</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">connection</span><span class="p">.</span><span class="nx">removeListener</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">onError</span>
    <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">connection</span>

  <span class="nx">reconnect</span><span class="p">()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 